name: CMake

on: [push, pull_request]

jobs:
  Workshop-Publish:
    # Skip building pull requests from the same repository
    if: ${{ github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository) }}
    name: Workshop Prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
      STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
      WORKSHOP_ID: 801875828
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Fetch .NET 6
      run: |
        sudo apt update
        sudo apt install dotnet6
    - name: Fetch gmodws
      run: |
        wget https://github.com/Meachamp/gmodws/releases/download/v1.5/gmodws.zip
        unzip gmodws.zip -d tools
        chmod +x ./tools/gmodws
    - name: Fetch DepotDownloader
      run: |
        wget https://github.com/SteamRE/DepotDownloader/releases/download/DepotDownloader_2.4.7/depotdownloader-2.4.7.zip
        unzip depotdownloader-2.4.7.zip -d tools
    - name: Fetch GMAD
      run: |
        echo "bin/gmad_linux" > gmad_files.txt
        dotnet ./tools/DepotDownloader.dll -app 4000 -depot 4003 -username $STEAM_USERNAME -password $STEAM_PASSWORD -filelist gmad_files.txt -dir gmod
        chmod +x ./gmod/bin/gmad_linux
    - name: Prepare package
      run: |
        ./CI/PreparePackage.sh
    - name: Create GMA
      run: |
        ./gmod/bin/gmad_linux create -folder publish -out lambda.gma
    - name: Upload to Workshop
      run: |
        ./tools/gmodws $STEAM_USERNAME $WORKSHOP_ID lambda.gma